

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>setlyze.database &mdash; SETLyze v1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SETLyze v1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SETLyze v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for setlyze.database</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#  Copyright 2010, GiMaRIS &lt;info@gimaris.com&gt;</span>
<span class="c">#</span>
<span class="c">#  This file is part of SETLyze - A tool for analyzing SETL data.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is free software: you can redistribute it and/or modify</span>
<span class="c">#  it under the terms of the GNU General Public License as published by</span>
<span class="c">#  the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#  (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is distributed in the hope that it will be useful,</span>
<span class="c">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#  GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#  You should have received a copy of the GNU General Public License</span>
<span class="c">#  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite</span>

<span class="kn">import</span> <span class="nn">setlyze.config</span>
<span class="kn">import</span> <span class="nn">setlyze.std</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2010, GiMaRIS&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;GPL3&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s">&quot;serrano.pereira@gmail.com&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s">&quot;Production&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s">&quot;2010/09/22&quot;</span>

<div class="viewcode-block" id="MakeLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB">[docs]</a><span class="k">class</span> <span class="nc">MakeLocalDB</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a local SQLite database with default tables, and fill some</span>
<span class="sd">    tables based on the called function.</span>

<span class="sd">    Design Part: 1.2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MakeLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MakeLocalDB.run"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decide which functions should be called.</span>

<span class="sd">        Design Part: 1.31</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Check if we need to make a new database file.</span>
        <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">):</span>
            <span class="c"># Create new database with data.</span>
            <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;setl-database&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_db</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_csv</span><span class="p">()</span>

            <span class="c"># Emit the signal that the local database has been created.</span>
            <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s">&quot;local-db-created&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a local SQLite database by loading data from the user</span>
<span class="sd">        selected CSV files.</span>

<span class="sd">        This method requires 4 CSV files:</span>
<span class="sd">            * localities_file, containing the SETL locations.</span>
<span class="sd">            * species_file, containing the SETL species.</span>
<span class="sd">            * records_file, containing the SETL records.</span>
<span class="sd">            * plates_file, containing the SETL plates.</span>

<span class="sd">        These files must be exported from the MS Access SETL database.</span>

<span class="sd">        Design Part: 1.32</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating local database from CSV files...&quot;</span><span class="p">)</span>

        <span class="c"># If data_source is not set to &quot;csv-msaccess&quot;, the required data</span>
        <span class="c"># files are probably not set by the user yet. ChangeDataSource</span>
        <span class="c"># must be called first.</span>
        <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Cannot run database.MakeLocalDB.insert_from_csv() while &#39;data-source&#39; is set to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Create a connection with the local database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Add some meta-data to a separate table in the local database.</span>
        <span class="c"># Add the data source we can figure out what kind of data is</span>
        <span class="c"># present.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">),</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c"># Also insert the data of creation, so we can give the user an</span>
        <span class="c"># indication when this database was created.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># Insert the data from the CSV files into the local database.</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_localities_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_plates_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_records_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_species_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c"># Close the connection with the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_localities_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_localities_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_localities_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the locations from a CSV file into the local database.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            delimiter</span>
<span class="sd">                A one-character string used to separate fields in the</span>
<span class="sd">                CSV file.</span>
<span class="sd">            quotechar</span>
<span class="sd">                A one-character string used to quote fields containing</span>
<span class="sd">                special characters in the CSV file.</span>

<span class="sd">        Design Part: 1.34</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO localities VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_species_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_species_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_species_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the species from a CSV file into the local database.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            delimiter</span>
<span class="sd">                A one-character string used to separate fields in the CSV</span>
<span class="sd">                file.</span>
<span class="sd">            quotechar</span>
<span class="sd">                A one-character string used to quote fields containing</span>
<span class="sd">                special characters in the CSV file.</span>

<span class="sd">        Design Part: 1.35</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO species VALUES (?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_plates_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_plates_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_plates_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the plates from a CSV file into the local database.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            delimiter</span>
<span class="sd">                A one-character string used to separate fields in the CSV</span>
<span class="sd">                file.</span>
<span class="sd">            quotechar</span>
<span class="sd">                A one-character string used to quote fields containing</span>
<span class="sd">                special characters in the CSV file.</span>

<span class="sd">        Design Part: 1.36</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO plates VALUES (?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_records_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_records_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_records_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the records from a CSV file into the local database.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            delimiter</span>
<span class="sd">                A one-character string used to separate fields in the CSV</span>
<span class="sd">                file.</span>
<span class="sd">            quotechar</span>
<span class="sd">                A one-character string used to quote fields containing</span>
<span class="sd">                special characters in the CSV file.</span>

<span class="sd">        Design Part: 1.37</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">38</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO records VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">placeholders</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">37</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a local SQLite database by loading data from the</span>
<span class="sd">        SETL PostgreSQL database. This method just loads the localities</span>
<span class="sd">        and the species into the local database.</span>

<span class="sd">        Design Part: 1.33</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating local database from SETL database...&quot;</span><span class="p">)</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Create a connection with the local database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Next time we run the tool, we&#39;ll know what data is in the</span>
        <span class="c"># database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">),)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># TODO: Insert data from SETL database.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Inserting data from the SETL database into local database...&quot;</span><span class="p">)</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c"># Close the connection with the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_new_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_new_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an empty database with the necessary tables.</span>

<span class="sd">        Design Part: 1.38</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating new local database file...&quot;</span><span class="p">)</span>

        <span class="c"># Check if the data folder exists. If not, create it.</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating data folder </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="c"># Delete the current database file.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="c"># This will automatically create a new database file.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Create the tables.</span>

        <span class="c"># This info table contains basic information about the</span>
        <span class="c"># local database. A version number could be handy in the future,</span>
        <span class="c"># for example we can notify the user if the local database is</span>
        <span class="c"># too old.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE info (</span><span class="se">\</span>
<span class="s">                        id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        name VARCHAR, </span><span class="se">\</span>
<span class="s">                        value VARCHAR)&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO info VALUES (null, &#39;version&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;0.1&quot;</span><span class="p">])</span>

        <span class="c"># Design Part: 2.4</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE localities (</span><span class="se">\</span>
<span class="s">                        loc_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        loc_name VARCHAR, </span><span class="se">\</span>
<span class="s">                        loc_nr VARCHAR, </span><span class="se">\</span>
<span class="s">                        loc_coordinates VARCHAR, </span><span class="se">\</span>
<span class="s">                        loc_description VARCHAR </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Design Part: 2.3</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species (</span><span class="se">\</span>
<span class="s">                        spe_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        spe_name_venacular VARCHAR, </span><span class="se">\</span>
<span class="s">                        spe_name_latin VARCHAR, </span><span class="se">\</span>
<span class="s">                        spe_invasive_in_nl INTEGER, </span><span class="se">\</span>
<span class="s">                        spe_description VARCHAR, </span><span class="se">\</span>
<span class="s">                        spe_remarks VARCHAR </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Design Part: 2.16</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE plates (</span><span class="se">\</span>
<span class="s">                        pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        pla_loc_id INTEGER, </span><span class="se">\</span>
<span class="s">                        pla_setl_coordinator VARCHAR, </span><span class="se">\</span>
<span class="s">                        pla_nr VARCHAR, </span><span class="se">\</span>
<span class="s">                        pla_deployment_date TEXT, </span><span class="se">\</span>
<span class="s">                        pla_retrieval_date TEXT, </span><span class="se">\</span>
<span class="s">                        pla_water_temperature VARCHAR, </span><span class="se">\</span>
<span class="s">                        pla_salinity VARCHAR, </span><span class="se">\</span>
<span class="s">                        pla_visibility VARCHAR, </span><span class="se">\</span>
<span class="s">                        pla_remarks VARCHAR </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Design Part: 2.5</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE records (</span><span class="se">\</span>
<span class="s">                        rec_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_spe_id INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_unknown INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_o INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_r INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_c INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_a INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_e INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur_unknown INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_sur25 INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_1st INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_2nd INTEGER, </span><span class="se">\</span>
<span class="s">                        rec_v INTEGER </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Note that rec_pla_id doesn&#39;t have to be unique, so we&#39;re</span>
        <span class="c"># creating a separate primary key &quot;id&quot;.</span>
        <span class="c"># Design Part: 2.9.1</span>
        <span class="c"># Design Part: 2.10.1</span>
        <span class="c"># Design Part: 2.11.1</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species_spots_1 (</span><span class="se">\</span>
<span class="s">                            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Note that rec_pla_id doesn&#39;t have to be unique, so we&#39;re</span>
        <span class="c"># creating a separate unique key &quot;id&quot;.</span>
        <span class="c"># Design Part: 2.9.2</span>
        <span class="c"># Design Part: 2.10.2</span>
        <span class="c"># Design Part: 2.11.2</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species_spots_2 (</span><span class="se">\</span>
<span class="s">                            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">                            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Create the table that will contain all the pre-calculated</span>
        <span class="c"># spot distances.</span>
        <span class="c"># Design Part: 2.23</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE spot_distances (</span><span class="se">\</span>
<span class="s">                        id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        delta_x INTEGER, </span><span class="se">\</span>
<span class="s">                        delta_y INTEGER, </span><span class="se">\</span>
<span class="s">                        distance REAL </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># The table for the found spot distances.</span>
        <span class="c"># Design Part: 2.12</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE spot_distances_observed (</span><span class="se">\</span>
<span class="s">                        id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">                        distance REAL </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># The table for the expected spot distances.</span>
        <span class="c"># Design Part: 2.13</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE spot_distances_expected (</span><span class="se">\</span>
<span class="s">                        id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">                        distance REAL </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># The table for the total of spots per plate in the distance</span>
        <span class="c"># tables.</span>
        <span class="c"># Design Part: 2.39</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE plate_spot_totals (</span><span class="se">\</span>
<span class="s">                        pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">                        n_spots_a INTEGER, </span><span class="se">\</span>
<span class="s">                        n_spots_b INTEGER </span><span class="se">\</span>
<span class="s">                        )&quot;</span><span class="p">)</span>

        <span class="c"># Commit the transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Fill the spot_distances table.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_distance_table</span><span class="p">()</span>

        <span class="c"># No need to make a new database, as we just created one.</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.fill_distance_table"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.fill_distance_table">[docs]</a>    <span class="k">def</span> <span class="nf">fill_distance_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate all possible spot distances for a SETL plate and put</span>
<span class="sd">        them in a table in the local database.</span>

<span class="sd">        Design Part: 1.47</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make log message.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Populating distances table...&quot;</span><span class="p">)</span>

        <span class="c"># Possible spot distances for a SETL plate. Moving horizontally</span>
        <span class="c"># or vertically from one spot to the next is defined as</span>
        <span class="c"># distance=1. Not moving means distance 0.</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

        <span class="c"># Create a Cartesian product for the possible distances.</span>
        <span class="n">products</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>

        <span class="c"># Connect to the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Now calculate the distance for each Cartesian product and put</span>
        <span class="c"># each distance in the table.</span>
        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO spot_distances &quot;</span>
                            <span class="s">&quot;VALUES (null,?,?,?)&quot;</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">))</span>
                            <span class="p">)</span>

        <span class="c"># Commit the transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="AccessDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDB">[docs]</a><span class="k">class</span> <span class="nc">AccessDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for accessing the database. Based on the setting of</span>
<span class="sd">    ``setlyze.config.cfg.get(&#39;data-source&#39;)``, this class wil either use the</span>
<span class="sd">    AccessLocalDB or AccessRemoteDB class to access the database.</span>

<span class="sd">    Design Part:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">AccessLocalDB</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;setl-database&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">AccessRemoteDB</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;AccessDB: &#39;</span><span class="si">%s</span><span class="s">&#39; is not a valid data source.&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric">[docs]</a><span class="k">class</span> <span class="nc">AccessDBGeneric</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Super class for AccessLocalDB and AccessRemoteDB.</span>

<span class="sd">    This class contains methods that are generic for both sub-classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AccessDBGeneric.get_locations"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_locations">[docs]</a>    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all locations from the local database.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list with tuples. Each tuple has the format</span>
<span class="sd">            ``(loc_id, &quot;loc_name&quot;)``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT loc_id, loc_name FROM localities&quot;</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">locations</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.set_species_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.set_species_spots">[docs]</a>    <span class="k">def</span> <span class="nf">set_species_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table in the local database containing the record</span>
<span class="sd">        information for the selected species and locations.</span>
<span class="sd">        A row consists of the plate ID, and spot 1–25. The spots can</span>
<span class="sd">        have a value 1 for present, or 0 for absent.</span>

<span class="sd">        Design Part: 1.19</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># The available tables to save the spots to.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Turn the list into a string, as it&#39;ll be included in the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Empty the required tables before we start.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Get plate ID and all 25 spots from each record that matches</span>
        <span class="c"># the list of record IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                        <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Insert each resulting row in the species_spots table.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span> <span class="n">row</span><span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.make_plates_unique"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.make_plates_unique">[docs]</a>    <span class="k">def</span> <span class="nf">make_plates_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Join the records in local database table &#39;species_spots&#39; that</span>
<span class="sd">        have the same plate ID. If one spot in a column contains 1, the</span>
<span class="sd">        resulting spot becomes 1. If all spots from a column are 0, the</span>
<span class="sd">        resulting spot becomes 0.</span>

<span class="sd">        The reason we&#39;re doing this, is because the user can select</span>
<span class="sd">        multiple species. The analysis should threat them as one specie.</span>

<span class="sd">        Design Part: 1.20</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># The available tables to save the spots to.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get all plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c"># Remove duplicate plate IDs.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pla_id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">:</span>
            <span class="c"># Get plate ID and all 25 spots for each plate ID.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                            <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                            <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                            <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                            <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                            <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                            <span class="p">)</span>

            <span class="c"># Create a combined record from all records with this</span>
            <span class="c"># plate ID.</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">combine_by_plate</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="c"># Remove all records with that plate ID from the</span>
            <span class="c"># species_spots table.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                            <span class="p">)</span>

            <span class="c"># Insert the combined record in the species_spots table. So</span>
            <span class="c"># this single record replaces all other records with this</span>
            <span class="c"># plate ID.</span>
            <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span>
                            <span class="n">combined</span>
                            <span class="p">)</span>

            <span class="c"># Keep track of the new records being added.</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the total numbers of unique plate records.</span>
        <span class="k">return</span> <span class="n">n</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.remove_single_spot_plates"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.remove_single_spot_plates">[docs]</a>    <span class="k">def</span> <span class="nf">remove_single_spot_plates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove records that have just one spot with True. Intra-specific</span>
<span class="sd">        distance can’t be calculated for those.</span>

<span class="sd">        Design Part: 1.21</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get all spots for each plate.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                        <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="n">delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="c"># Count total True&#39;s (n) for each record.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c"># Again, skip the first item, as it&#39;s the plate ID.</span>
                <span class="c"># Count the number of True&#39;s.</span>
                <span class="k">if</span> <span class="n">spot</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># Total (n) must be at least 2; if not, add that plate ID</span>
            <span class="c"># to the list of to be deleted plates/records.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Create a string of the IDs.</span>
        <span class="n">delete_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">delete</span><span class="p">])</span>

        <span class="c"># Delete the records in the list of plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">delete_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="c"># Design Part: 2.10 -&gt; 2.11</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the list of deleted plates.</span>
        <span class="k">return</span> <span class="n">delete</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.fill_plate_spot_totals_table"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.fill_plate_spot_totals_table">[docs]</a>    <span class="k">def</span> <span class="nf">fill_plate_spot_totals_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill the &#39;plate_spot_totals&#39; table with the unique plate IDs</span>
<span class="sd">        from the spots tables and the number of positive spots each</span>
<span class="sd">        plate contains.</span>

<span class="sd">        This table is used by several analysis functions:</span>
<span class="sd">            * Calculating the expected distances, where the spot numbers</span>
<span class="sd">              serve as a template for the random spots generator.</span>

<span class="sd">            * Significance calculators, where the tests are applied to</span>
<span class="sd">              plates with specific numbers of positive spots.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            spots_table1</span>
<span class="sd">                The name of a spots table.</span>
<span class="sd">            spots_table2</span>
<span class="sd">                The name of a second spots table (optional).</span>

<span class="sd">        If just one table is provided, only the column &#39;n_spots_a&#39; is</span>
<span class="sd">        filled. If two spots tables are provided, &#39;n_spots_a&#39; is filled</span>
<span class="sd">        from the first spots table, and &#39;n_spots_b&#39; filled from the</span>
<span class="sd">        second spots table.</span>

<span class="sd">        Design Part: 1.73</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Empty the plate_spot_totals table before we use it again.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DELETE FROM plate_spot_totals&quot;</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">spots_table2</span><span class="p">:</span>
            <span class="c"># Two spots tables are provided.</span>

            <span class="c"># Get all records from both spots tables where the plate IDs</span>
            <span class="c"># match.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25|id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|</span>
            <span class="c"># rec_sur4|rec_sur5|rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|</span>
            <span class="c"># rec_sur11|rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|</span>
            <span class="c"># rec_sur17|rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|</span>
            <span class="c"># rec_sur23|rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT s1.*, s2.* FROM </span><span class="si">%s</span><span class="s"> as s1 &quot;</span>
                            <span class="s">&quot;INNER JOIN </span><span class="si">%s</span><span class="s"> as s2 &quot;</span>
                            <span class="s">&quot;ON s1.rec_pla_id=s2.rec_pla_id&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="p">)</span>
                            <span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">record1</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span>
                <span class="n">record2</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>

                <span class="c"># Get the positive spots for both records.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record2</span><span class="p">)</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots2</span><span class="p">)</span>

                <span class="c"># Skip this plate if both records contain less than 1</span>
                <span class="c"># positive spot.</span>
                <span class="c"># We won&#39;t be able to calculate distances for such records</span>
                <span class="c"># anyway.</span>
                <span class="k">if</span> <span class="n">spots1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spots2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the</span>
                <span class="c"># plate_spot_totals table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,?)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spots1</span><span class="p">,</span> <span class="n">spots2</span><span class="p">)</span>
                                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># One spots table is provided.</span>

            <span class="c"># Get all spots for each plate.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spots_table1</span><span class="p">)</span>
                            <span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="c"># Get the positive spots for this plate.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots</span><span class="p">)</span>

                <span class="c"># Skip this record if it contains less than 2 positive spots.</span>
                <span class="c"># We won&#39;t be able to calculate a distance for such records</span>
                <span class="c"># anyway.</span>
                <span class="k">if</span> <span class="n">spots</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the</span>
                <span class="c"># plate_spot_totals table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,null)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spots</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="c"># Commit the transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the number of records that were skipped.</span>
        <span class="k">return</span> <span class="n">skipped</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_distances_matching_spots_total"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_distances_matching_spots_total">[docs]</a>    <span class="k">def</span> <span class="nf">get_distances_matching_spots_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">distance_table</span><span class="p">,</span> <span class="n">spots_n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the distances from a distance table that are from plates</span>
<span class="sd">        matching a specific number of spots on a plate.</span>

<span class="sd">        This function is specific to analysis 2.1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spots_n</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c"># If spots_n=-1, get all distances.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT distance FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">distance_table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the plate IDs that match the provided total spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_n</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

            <span class="c"># Get the distances that match the plate IDs.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids</span><span class="p">)</span>
                            <span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AccessLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB">[docs]</a><span class="k">class</span> <span class="nc">AccessLocalDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve data from the local SQLite database.</span>

<span class="sd">    Design Part: 1.28</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="AccessLocalDB.get_species"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_species">[docs]</a>    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc_slot</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of species that match the selected locations from</span>
<span class="sd">        the local database.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">            loc_slot</span>
<span class="sd">                An integer defining which location selection to use,</span>
<span class="sd">                as a selection variable contains on or more selection</span>
<span class="sd">                lists. Default the first selection list is returned</span>
<span class="sd">                (loc_slot=0).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list with tuples in the format ``(spe_id,</span>
<span class="sd">            &quot;spe_name_venacular&quot;, &quot;spe_name_latin&quot;)``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Get one of the location selections.</span>
        <span class="n">locations_selection</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;locations-selection&#39;</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">loc_slot</span><span class="p">)</span>

        <span class="c"># Connect to the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Select all plate IDs from plates that are from the selected</span>
        <span class="c"># locations.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations_selection</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">placeholders</span><span class="p">),</span> <span class="n">locations_selection</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>
        <span class="c">#print &quot;pla_ids: &quot;, pla_ids</span>

        <span class="c"># Select all specie IDs from records with those plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT rec_spe_id FROM records WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) AND rec_spe_id != &#39;&#39;&quot;</span> <span class="o">%</span> <span class="n">pla_ids_str</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">spe_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">spe_ids</span><span class="p">])</span> <span class="c"># Turn the list into a string</span>
        <span class="c">#print &quot;spe_ids: &quot;, spe_ids</span>

        <span class="c"># Select information from species that match those species IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT spe_id, spe_name_venacular, spe_name_latin FROM species WHERE spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">spe_ids_str</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">species</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_record_ids"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_record_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_record_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc_ids</span><span class="p">,</span> <span class="n">spe_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the record IDs that match both the provided locations and</span>
<span class="sd">        species IDs.</span>

<span class="sd">        Design Part: 1.41</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create strings containing all the selected locations and</span>
        <span class="c"># species IDs. These will be part of the queries below.</span>
        <span class="n">loc_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">loc_ids</span><span class="p">])</span>
        <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">spe_ids</span><span class="p">])</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get the plate IDs that match the selected locations.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">loc_ids_str</span><span class="p">))</span>

        <span class="c"># Construct a list with the plate IDs.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>

        <span class="c"># Select all record IDs that match the plate IDs and the</span>
        <span class="c"># selected species.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_id FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) &quot;</span>
                        <span class="s">&quot;AND rec_spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">pla_ids_str</span><span class="p">,</span> <span class="n">spe_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Construct a list with the record IDs.</span>
        <span class="n">rec_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">rec_ids</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_spots">[docs]</a>    <span class="k">def</span> <span class="nf">get_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all the spot booleans for the specified records.&quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Get all 25 spots from each record that matches the list of</span>
        <span class="c"># record IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">records</span>

</div></div>
<div class="viewcode-block" id="AccessRemoteDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessRemoteDB">[docs]</a><span class="k">class</span> <span class="nc">AccessRemoteDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve data from the SETL database.</span>

<span class="sd">    Design Part: 1.29</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessRemoteDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/setl-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SETLyze v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, GiMaRIS.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>