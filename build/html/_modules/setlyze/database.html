

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>setlyze.database &mdash; SETLyze v1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SETLyze v1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SETLyze v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for setlyze.database</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#  Copyright 2010, GiMaRIS &lt;info@gimaris.com&gt;</span>
<span class="c">#</span>
<span class="c">#  This file is part of SETLyze - A tool for analyzing the settlement of species.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is free software: you can redistribute it and/or modify</span>
<span class="c">#  it under the terms of the GNU General Public License as published by</span>
<span class="c">#  the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#  (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is distributed in the hope that it will be useful,</span>
<span class="c">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#  GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#  You should have received a copy of the GNU General Public License</span>
<span class="c">#  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Facilitate access to the local SQLite database and the remote SETL</span>
<span class="sd">database.</span>

<span class="sd">The local SQLite database is created by :meth:`setlyze.database.MakeLocalDB.create_new_db`.</span>
<span class="sd">It is created using the SQLite Python module. This database is used</span>
<span class="sd">internally by SETLyze for local data storage and allows for the</span>
<span class="sd">execution of SQL queries. The database is a single file created in the</span>
<span class="sd">user&#39;s home directory in a subfolder called ``.setlyze``.</span>

<span class="sd">Here we refer to the PostgreSQL SETL database as the remote SETL</span>
<span class="sd">database.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">gobject</span>

<span class="kn">import</span> <span class="nn">setlyze.config</span>
<span class="kn">import</span> <span class="nn">setlyze.std</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2010, GiMaRIS&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;GPL3&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s">&quot;serrano.pereira@gmail.com&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s">&quot;Production&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s">&quot;2010/09/22&quot;</span>

<div class="viewcode-block" id="get_database_accessor"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.get_database_accessor">[docs]</a><span class="k">def</span> <span class="nf">get_database_accessor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return an object that facilitates access to either the local or</span>
<span class="sd">    the remote database.</span>

<span class="sd">    Based on the data source configuration, obtained with</span>
<span class="sd">    ``setlyze.config.cfg.get(&#39;data-source&#39;)``, this function wil either</span>
<span class="sd">    return an instance of AccessLocalDB or AccessRemoteDB. This instance</span>
<span class="sd">    provides methods that are specific to the data source currently in</span>
<span class="sd">    use.</span>

<span class="sd">    Design Part: 1.93</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">AccessLocalDB</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;setl-database&quot;</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">AccessRemoteDB</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;setlyze.database.get_database_accessor: &#39;</span><span class="si">%s</span><span class="s">&#39; is not a valid data source.&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>
</div>
<div class="viewcode-block" id="get_plates_total_matching_spots_total"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.get_plates_total_matching_spots_total">[docs]</a><span class="k">def</span> <span class="nf">get_plates_total_matching_spots_total</span><span class="p">(</span><span class="n">n_spots</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an integer representing the number of plates that</span>
<span class="sd">    match the provided number of positive spots `n_spots`.</span>

<span class="sd">    Possible values for `slot` are 0 for the first species selection,</span>
<span class="sd">    and 1 for the second species selection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">))</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;n_spots_a&#39;</span>
    <span class="k">elif</span> <span class="n">slot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;n_spots_b&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Possible values for &#39;slot&#39; are 0 and 1.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_spots</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c"># If spots_n is a negative number, get all distances</span>
        <span class="c"># up to the absolute number. So if we find -5, get all</span>
        <span class="c"># distances with up to 5 spots.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT COUNT(pla_id) &quot;</span>
                        <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                        <span class="s">&quot;WHERE </span><span class="si">%s</span><span class="s"> &lt;= ?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">),</span>
                        <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">n_spots</span><span class="p">)])</span>
        <span class="n">n_plates</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># If it&#39;s a positive number, just get the plates that</span>
        <span class="c"># match that spots number.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT COUNT(pla_id) &quot;</span>
                        <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                        <span class="s">&quot;WHERE </span><span class="si">%s</span><span class="s"> = ?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">),</span>
                        <span class="p">[</span><span class="n">n_spots</span><span class="p">])</span>
        <span class="n">n_plates</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">n_plates</span>

</div>
<div class="viewcode-block" id="MakeLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB">[docs]</a><span class="k">class</span> <span class="nc">MakeLocalDB</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a local SQLite database with default tables and fill some</span>
<span class="sd">    tables based on the data source.</span>

<span class="sd">    This class can load data from two data sources. One data source</span>
<span class="sd">    is user supplied CSV files containing SETL data. The CSV files must</span>
<span class="sd">    be exported by the MS Access SETL database.</span>
<span class="sd">    The second source is the PostgreSQL SETL database. This function</span>
<span class="sd">    requires a direct connection with the SETL database server.</span>

<span class="sd">    Because the import of SETL data into the local database can take</span>
<span class="sd">    a while, and instance of this class must run in a separate thread.</span>
<span class="sd">    An instance of this class is therefor a thread object.</span>

<span class="sd">    Once a thread object is created, its activity must be started by</span>
<span class="sd">    calling the thread’s start() method. This invokes the run() method</span>
<span class="sd">    in a separate thread of control.</span>

<span class="sd">    Design Part: 1.2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MakeLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MakeLocalDB.run"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decide based on the configuration variables which functions</span>
<span class="sd">        should be called.</span>

<span class="sd">        This method first checks if SETLyze is configured to create</span>
<span class="sd">        a new local database. This is done by checking the value of</span>
<span class="sd">        ``setlyze.config.cfg.get(&#39;make-new-db&#39;)``. If this is set to</span>
<span class="sd">        ``False``, the method ends and the thread is destroyed. If set</span>
<span class="sd">        to ``True``, a new local database is created based on the data</span>
<span class="sd">        source configuration.</span>

<span class="sd">        The data source configuration is checked by calling</span>
<span class="sd">        ``setlyze.config.cfg.get(&#39;data-source&#39;)``. If this is set to</span>
<span class="sd">        ``setl-database``, the method ``insert_from_db`` is called and</span>
<span class="sd">        some SETL data from the remote SETL database is loaded into the</span>
<span class="sd">        local database. If set to ``csv-msaccess``, the method</span>
<span class="sd">        ``insert_from_csv`` is called which loads all SETL data from the</span>
<span class="sd">        supplied CSV files into the local database.</span>

<span class="sd">        Design Part: 1.31</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Check if we need to make a new database file.</span>
        <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">):</span>
            <span class="c"># Create new database with data.</span>
            <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;setl-database&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_db</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_csv</span><span class="p">()</span>

            <span class="c"># Emit the signal that the local database has been created.</span>
            <span class="c"># Note that the signal will be sent from a separate thread,</span>
            <span class="c"># so we must use gobject.idle_add.</span>
            <span class="n">gobject</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="s">&#39;local-db-created&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database and load all SETL data from the</span>
<span class="sd">        user selected CSV files into the local database.</span>

<span class="sd">        The SETL data is loaded from four separate CSV files:</span>
<span class="sd">            * localities_file, containing the SETL locations.</span>
<span class="sd">            * species_file, containing the SETL species.</span>
<span class="sd">            * records_file, containing the SETL records.</span>
<span class="sd">            * plates_file, containing the SETL plates.</span>

<span class="sd">        These files must be exported from the MS Access SETL database</span>
<span class="sd">        and contain all fields. The CSV file must be in Excel format,</span>
<span class="sd">        which means delimited by semicolons (;) and double quotes (&quot;) as</span>
<span class="sd">        the quote character for fields with special characters.</span>

<span class="sd">        Design Part: 1.32</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating local database from CSV files...&quot;</span><span class="p">)</span>

        <span class="c"># If data_source is not set to &quot;csv-msaccess&quot;, the required data</span>
        <span class="c"># files are probably not set by the user yet. ChangeDataSource</span>
        <span class="c"># must be called first.</span>
        <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;csv-msaccess&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Cannot run database.MakeLocalDB.insert_from_csv() while &#39;data-source&#39; is set to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Create a connection with the local database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Add some meta-data to a separate table in the local database.</span>
        <span class="c"># Add the data source we can figure out what kind of data is</span>
        <span class="c"># present.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">),</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c"># Also insert the data of creation, so we can give the user an</span>
        <span class="c"># indication when this database was created.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># Insert the data from the CSV files into the local database.</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_localities_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_plates_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_records_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_species_from_csv</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c"># Close the connection with the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_localities_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_localities_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_localities_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the SETL localities from a CSV file into the local</span>
<span class="sd">        database.</span>

<span class="sd">        `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file. `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file.</span>
<span class="sd">        The default values for these two arguments are suited for CSV</span>
<span class="sd">        files in Excel format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.18`.</span>

<span class="sd">        Design Part: 1.34</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO localities VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_species_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_species_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_species_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the species from a CSV file into the local database.</span>

<span class="sd">        `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file. `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file.</span>
<span class="sd">        The default values for these two arguments are suited for CSV</span>
<span class="sd">        files in Excel format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.19`.</span>

<span class="sd">        Design Part: 1.35</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO species VALUES (?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_plates_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_plates_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_plates_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the plates from a CSV file into the local database.</span>

<span class="sd">        `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file. `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file.</span>
<span class="sd">        The default values for these two arguments are suited for CSV</span>
<span class="sd">        files in Excel format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.20`.</span>

<span class="sd">        Design Part: 1.36</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO plates VALUES (?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_records_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_records_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_records_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the records from a CSV file into the local database.</span>

<span class="sd">        `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file. `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file.</span>
<span class="sd">        The default values for these two arguments are suited for CSV</span>
<span class="sd">        files in Excel format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.21`.</span>

<span class="sd">        Design Part: 1.37</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">))</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">38</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO records VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">placeholders</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">37</span><span class="p">])</span>
                <span class="p">)</span>

        <span class="c"># Commit the database changes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database and load localities and species</span>
<span class="sd">        data from the remote SETL database into the local database.</span>

<span class="sd">        This method requires a direct connection with the SETL</span>
<span class="sd">        database server.</span>

<span class="sd">        The reason why we don&#39;t load all SETL data into the local database</span>
<span class="sd">        is because we can execute queries on the remote database. So</span>
<span class="sd">        there&#39;s no need to load large amounts of data onto the user&#39;s</span>
<span class="sd">        computer. Because the localities and species data is accessed</span>
<span class="sd">        often, loading this into the local database increases speed of</span>
<span class="sd">        the application.</span>

<span class="sd">        Design Part: 1.33</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating local database from SETL database...&quot;</span><span class="p">)</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Create a connection with the local database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c"># Next time we run the tool, we&#39;ll know what data is in the</span>
        <span class="c"># database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">),)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># TODO: Insert data from SETL database.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Inserting data from the SETL database into local database...&quot;</span><span class="p">)</span>

        <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">update_progress_dialog</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c"># Close the connection with the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_new_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_new_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database and then calls the methods</span>
<span class="sd">        that create the necessary tables.</span>

<span class="sd">        This deletes the current local database if present in the user&#39;s</span>
<span class="sd">        home folder.</span>

<span class="sd">        Design Part: 1.38</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating new local database file...&quot;</span><span class="p">)</span>

        <span class="c"># Check if the data folder exists. If not, create it.</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating data folder </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="c"># Delete the current database file.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_db_file</span><span class="p">()</span>

        <span class="c"># This will automatically create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Create the tables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_localities</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_species</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_plates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_records</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_species_spots_1</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_species_spots_2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_spot_distances_observed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_spot_distances_expected</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_plate_spot_totals</span><span class="p">()</span>

        <span class="c"># Commit the transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># No need to make a new database, as we just created one.</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.remove_db_file"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.remove_db_file">[docs]</a>    <span class="k">def</span> <span class="nf">remove_db_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the database file.</span>

<span class="sd">        This method does 3 tries if for some reason the database file</span>
<span class="sd">        could not be deleted (e.g. the file is in use by a different</span>
<span class="sd">        process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s">&quot;I was unable to remove the file </span><span class="si">%s</span><span class="s">. &quot;</span>
                <span class="s">&quot;Please make sure it&#39;s not in use by a different &quot;</span>
                <span class="s">&quot;process.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_db_file</span><span class="p">(</span><span class="n">tries</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_info"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_info">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for storing basic information about the</span>
<span class="sd">        local database.</span>

<span class="sd">        This information includes its creation date and the data source.</span>
<span class="sd">        The data source is either the SETL database (MS Access/PostgreSQL)</span>
<span class="sd">        or CSV files containing SETL data. A version number for the</span>
<span class="sd">        database is also saved. This could be handy in the future,</span>
<span class="sd">        for example we can notify the user if the local database is</span>
<span class="sd">        too old, followed by creating a new local database.</span>

<span class="sd">        Design Part: 1.75</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db_version</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE info (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            name VARCHAR, </span><span class="se">\</span>
<span class="s">            value VARCHAR)&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO info &quot;</span>
            <span class="s">&quot;VALUES (null, &#39;version&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">db_version</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_localities"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_localities">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_localities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the SETL localities.</span>

<span class="sd">        Because the data from this table is accessed frequently, the</span>
<span class="sd">        localities records are automatically saved to this table when</span>
<span class="sd">        an analyze is started.</span>

<span class="sd">        Design Part: 1.76</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Design Part: 2.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE localities (</span><span class="se">\</span>
<span class="s">            loc_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            loc_name VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_nr VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_coordinates VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_description VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_species"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_species">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the SETL species.</span>

<span class="sd">        Because the data from this table is accessed frequently, the</span>
<span class="sd">        species records are automatically saved to this table when</span>
<span class="sd">        an analyze is started.</span>

<span class="sd">        Design Part: 1.77</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species (</span><span class="se">\</span>
<span class="s">            spe_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            spe_name_venacular VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_name_latin VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_invasive_in_nl INTEGER, </span><span class="se">\</span>
<span class="s">            spe_description VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_remarks VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_plates"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_plates">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the SETL plates.</span>

<span class="sd">        This table is only filled if the user selected CSV files to</span>
<span class="sd">        import SETL data from. If the remote SETL database is used,</span>
<span class="sd">        the plate records are obtained directly via queries.</span>

<span class="sd">        Design Part: 1.78</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Design Part: 2.16</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE plates (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            pla_loc_id INTEGER, </span><span class="se">\</span>
<span class="s">            pla_setl_coordinator VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_nr VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_deployment_date TEXT, </span><span class="se">\</span>
<span class="s">            pla_retrieval_date TEXT, </span><span class="se">\</span>
<span class="s">            pla_water_temperature VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_salinity VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_visibility VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_remarks VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_records"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_records">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the SETL records.</span>

<span class="sd">        This table is only filled if the user selected CSV files to</span>
<span class="sd">        import SETL data from. If the remote SETL database is used,</span>
<span class="sd">        the records are obtained directly via queries.</span>

<span class="sd">        Design Part: 1.79</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE records (</span><span class="se">\</span>
<span class="s">            rec_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_spe_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_unknown INTEGER, </span><span class="se">\</span>
<span class="s">            rec_o INTEGER, </span><span class="se">\</span>
<span class="s">            rec_r INTEGER, </span><span class="se">\</span>
<span class="s">            rec_c INTEGER, </span><span class="se">\</span>
<span class="s">            rec_a INTEGER, </span><span class="se">\</span>
<span class="s">            rec_e INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur_unknown INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_1st INTEGER, </span><span class="se">\</span>
<span class="s">            rec_2nd INTEGER, </span><span class="se">\</span>
<span class="s">            rec_v INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_species_spots_1"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_species_spots_1">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species_spots_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table that will contain the SETL records for the</span>
<span class="sd">        first species selection.</span>

<span class="sd">        Because the user can select multiple species, the plate IDs in</span>
<span class="sd">        column ``rec_pla_id`` don&#39;t have to be unique, so we&#39;re</span>
<span class="sd">        creating a separate column ``id`` as the primary key.</span>

<span class="sd">        Design Part: 1.80</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.9, 2.9.1, 2.9.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species_spots_1 (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_species_spots_2"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_species_spots_2">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species_spots_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table that will contain the SETL records for the</span>
<span class="sd">        second species selection.</span>

<span class="sd">        Because the user can select multiple species, the plate IDs in</span>
<span class="sd">        column ``rec_pla_id`` don&#39;t have to be unique, so we&#39;re</span>
<span class="sd">        creating a separate column ``id`` as the primary key.</span>

<span class="sd">        Design Part: 1.81</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.10, 2.10.1, 2.10.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species_spots_2 (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_spot_distances_observed"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_spot_distances_observed">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_spot_distances_observed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the observed spot distances.</span>

<span class="sd">        Design Part: 1.83</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE spot_distances_observed (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            distance REAL </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_spot_distances_expected"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_spot_distances_expected">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_spot_distances_expected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the expected spot distances.</span>

<span class="sd">        Design Part: 1.84</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.13</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE spot_distances_expected (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            distance REAL </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_plate_spot_totals"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_plate_spot_totals">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plate_spot_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table for the total of spots per plate in the</span>
<span class="sd">        distance tables.</span>

<span class="sd">        Design Part: 1.85</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.39</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE plate_spot_totals (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            n_spots_a INTEGER, </span><span class="se">\</span>
<span class="s">            n_spots_b INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="AccessDBGeneric"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric">[docs]</a><span class="k">class</span> <span class="nc">AccessDBGeneric</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Super class for :class:`AccessLocalDB` and :class:`AccessRemoteDB`.</span>

<span class="sd">    This class contains methods that are generic for both sub-classes.</span>
<span class="sd">    It provides both sub classes with methods for data that is always</span>
<span class="sd">    present in the local database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AccessDBGeneric.get_database_info"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_database_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_database_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return info (creation date, data source) stored in the local</span>
<span class="sd">        database file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT value FROM info WHERE name=&#39;source&#39;&quot;</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT value FROM info WHERE name=&#39;date&#39;&quot;</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">info</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_locations"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_locations">[docs]</a>    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all locations from the local database.</span>

<span class="sd">        Returns a list of tuples ``(loc_id, &#39;loc_name&#39;)``.</span>

<span class="sd">        Design Part: 1.95</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT loc_id, loc_name FROM localities&quot;</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">locations</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.make_plates_unique"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.make_plates_unique">[docs]</a>    <span class="k">def</span> <span class="nf">make_plates_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the records with the same plate ID in a spots table.</span>
<span class="sd">        The value for `slot` defines which spots table is used.</span>
<span class="sd">        The possible values of `slot` are ``0`` for table</span>
<span class="sd">        ``species_spots_1`` and ``1`` for ``species_spots_2``.</span>

<span class="sd">        We&#39;re doing this so we can threat multiple species selected by</span>
<span class="sd">        the user as a single species.</span>

<span class="sd">        Design Part: 1.20</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># The available tables to save the spots to.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get all plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="c"># Remove duplicate plate IDs.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pla_id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">:</span>
            <span class="c"># Get plate ID and all 25 spots for each plate ID.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                            <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                            <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                            <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                            <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                            <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                            <span class="p">)</span>

            <span class="c"># Create a combined record from all records with this</span>
            <span class="c"># plate ID.</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">combine_records</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="c"># Remove all records with that plate ID from the</span>
            <span class="c"># species_spots table.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                            <span class="p">)</span>

            <span class="c"># Insert the combined record in the species_spots table. So</span>
            <span class="c"># this single record replaces all other records with this</span>
            <span class="c"># plate ID.</span>
            <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span>
                            <span class="n">combined</span>
                            <span class="p">)</span>

            <span class="c"># Keep track of the new records being added.</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the total numbers of unique plate records.</span>
        <span class="k">return</span> <span class="n">n</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.remove_single_spot_plates"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.remove_single_spot_plates">[docs]</a>    <span class="k">def</span> <span class="nf">remove_single_spot_plates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove records that have just one positive spot. Intra-specific</span>
<span class="sd">        distance can’t be calculated for those.</span>

<span class="sd">        .. deprecated:: 0.1</span>
<span class="sd">           Use of this function is discouraged. You can easily check for</span>
<span class="sd">           a minimum number of spots in your functions. Also the function</span>
<span class="sd">           :meth:`~setlyze.std.get_spot_combinations_from_record` will</span>
<span class="sd">           return an empty list if no combinations are possibe (e.g. the</span>
<span class="sd">           record contains less than 2 positive spots).</span>

<span class="sd">        Design Part: 1.21</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get all spots for each plate.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                        <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="n">delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="c"># Count total True&#39;s (n) for each record.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c"># Again, skip the first item, as it&#39;s the plate ID.</span>
                <span class="c"># Count the number of True&#39;s.</span>
                <span class="k">if</span> <span class="n">spot</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># Total (n) must be at least 2; if not, add that plate ID</span>
            <span class="c"># to the list of to be deleted plates/records.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Create a string of the IDs.</span>
        <span class="n">delete_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">delete</span><span class="p">])</span>

        <span class="c"># Delete the records in the list of plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">delete_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="c"># Design Part: 2.10 -&gt; 2.11</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the list of deleted plates.</span>
        <span class="k">return</span> <span class="n">delete</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.fill_plate_spot_totals_table"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.fill_plate_spot_totals_table">[docs]</a>    <span class="k">def</span> <span class="nf">fill_plate_spot_totals_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill the ``plate_spot_totals`` table with the number of</span>
<span class="sd">        positive spots for each plate.</span>

<span class="sd">        The information is obtained from the tables `spots_table1` and</span>
<span class="sd">        `spots_table2` (optional).</span>

<span class="sd">        The ``plate_spot_totals`` table is used in several situations:</span>

<span class="sd">            * Calculating the expected distances, where the positive spot</span>
<span class="sd">              number serves as a template for the random spots generator</span>
<span class="sd">              (see :ref:`~setlyze.std.get_random_for_plate`).</span>

<span class="sd">            * Significance calculators, where the tests are applied to</span>
<span class="sd">              plates with a specific number of positive spots (see</span>
<span class="sd">              :ref:`get_distances_matching_spots_total`).</span>

<span class="sd">        If just `spots_table1` is provided, only the column ``n_spots_a``</span>
<span class="sd">        is filled with positive spot numbers. If both `spots_table1` and</span>
<span class="sd">        `spots_table2` are provided, ``n_spots_a`` is filled</span>
<span class="sd">        from `spots_table1`, and ``n_spots_b`` filled from `spots_table2`.</span>

<span class="sd">        Design Part: 1.73</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Empty the plate_spot_totals table before we use it again.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DELETE FROM plate_spot_totals&quot;</span><span class="p">)</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">spots_table2</span><span class="p">:</span>
            <span class="c"># Two spots tables are provided.</span>

            <span class="c"># Get all records from both spots tables where the plate IDs</span>
            <span class="c"># match.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25|id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|</span>
            <span class="c"># rec_sur4|rec_sur5|rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|</span>
            <span class="c"># rec_sur11|rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|</span>
            <span class="c"># rec_sur17|rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|</span>
            <span class="c"># rec_sur23|rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT s1.*, s2.* FROM </span><span class="si">%s</span><span class="s"> as s1 &quot;</span>
                            <span class="s">&quot;INNER JOIN </span><span class="si">%s</span><span class="s"> as s2 &quot;</span>
                            <span class="s">&quot;ON s1.rec_pla_id=s2.rec_pla_id&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="p">)</span>
                            <span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">record1</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span>
                <span class="n">record2</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>
                <span class="n">plate_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c"># Get the positive spots for both records.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record2</span><span class="p">)</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots2</span><span class="p">)</span>

                <span class="c"># Skip this plate if both records contain less than 1</span>
                <span class="c"># positive spot.</span>
                <span class="c"># We won&#39;t be able to calculate distances for such records</span>
                <span class="c"># anyway.</span>
                <span class="k">if</span> <span class="n">spots1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spots2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the</span>
                <span class="c"># plate_spot_totals table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,?)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">plate_id</span><span class="p">,</span> <span class="n">spots1</span><span class="p">,</span> <span class="n">spots2</span><span class="p">)</span>
                                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># One spots table is provided.</span>

            <span class="c"># Get all spots for each plate.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spots_table1</span><span class="p">)</span>
                            <span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">plate_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c"># Get the positive spots for this record.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots</span><span class="p">)</span>

                <span class="c"># Skip this record if it contains less than 2 positive spots.</span>
                <span class="c"># We won&#39;t be able to calculate a distance for such records</span>
                <span class="c"># anyway.</span>
                <span class="k">if</span> <span class="n">spots</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the</span>
                <span class="c"># plate_spot_totals table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,null)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">plate_id</span><span class="p">,</span> <span class="n">spots</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="c"># Commit the transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the number of records that were skipped.</span>
        <span class="k">return</span> <span class="n">skipped</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_distances_matching_spots_total"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_distances_matching_spots_total">[docs]</a>    <span class="k">def</span> <span class="nf">get_distances_matching_spots_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">distance_table</span><span class="p">,</span> <span class="n">spots_n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the distances from distance table `distance_table` that</span>
<span class="sd">        are from plates having `spots_n` positive spot numbers.</span>

<span class="sd">        `cursor` must be a SQLite cursor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spots_n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># If spots_n is a negative number, get all distances</span>
            <span class="c"># up to the absolute number. So if we find -5, get all</span>
            <span class="c"># distances up to 5.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT distance FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">distance_table</span><span class="p">)</span>

            <span class="c"># Get the plate IDs that have n spots lower or equal to the</span>
            <span class="c"># absolute spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a &lt;= </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spots_n</span><span class="p">))</span>
                            <span class="p">)</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

            <span class="c"># Get the distances that match the plate IDs.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids</span><span class="p">)</span>
                            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the plate IDs that match the provided total spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_n</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

            <span class="c"># Get the distances that match the plate IDs.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids</span><span class="p">)</span>
                            <span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_distances_matching_ratios"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_distances_matching_ratios">[docs]</a>    <span class="k">def</span> <span class="nf">get_distances_matching_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">distance_table</span><span class="p">,</span> <span class="n">ratios</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spot distances from distance table `distance_table` where</span>
<span class="sd">        positive spots numbers between species A and B have ratio</span>
<span class="sd">        matching the list of ratios `ratios`.</span>

<span class="sd">        The ratio A:B is considered the same as B:A.</span>

<span class="sd">        `cursor` must be a SQLite cursor object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plate_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
            <span class="c"># Get the plate IDs that match the ratio A:B.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s"> &quot;</span>
                            <span class="s">&quot;AND n_spots_b = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>

            <span class="c"># Add the plate IDs to the list of plate IDs.</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="n">plate_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

            <span class="c"># We need the complement ratio B:A as well, so we get the</span>
            <span class="c"># plate IDs for the complement as well.</span>

            <span class="c"># No need to get the complement ratio if it&#39;s the same.</span>
            <span class="k">if</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c"># Get the plate IDs that match the complement ratio B:A.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s"> &quot;</span>
                            <span class="s">&quot;AND n_spots_b = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="p">)</span>

            <span class="c"># Add the plate IDs to the list of plate IDs.</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="n">plate_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="c"># Turn the list of plate IDs into a string.</span>
        <span class="n">plate_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

        <span class="c"># Get the distances that match the plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                        <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">plate_ids</span>
</div></div>
<div class="viewcode-block" id="AccessLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB">[docs]</a><span class="k">class</span> <span class="nc">AccessLocalDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide standard methods for accessing data in the local</span>
<span class="sd">    SQLite database. These methods are only used when the data source</span>
<span class="sd">    is set to ``csv-msaccess``.</span>

<span class="sd">    Inherits from :class:`AccessDBGeneric` which provides this</span>
<span class="sd">    class with methods that are not data source specific.</span>

<span class="sd">    Design Part: 1.28</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="AccessLocalDB.get_species"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_species">[docs]</a>    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc_slot</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of species tuples in the format ``(spe_id,</span>
<span class="sd">        &#39;spe_name_venacular&#39;, &#39;spe_name_latin&#39;)`` from the local</span>
<span class="sd">        database that match the localities selection.</span>

<span class="sd">        The values for `loc_slot` are ``0`` for the first localities</span>
<span class="sd">        selection and ``1`` for the second localities selection.</span>

<span class="sd">        Design Part: 1.96</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Get one of the location selections.</span>
        <span class="n">locations_selection</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;locations-selection&#39;</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">loc_slot</span><span class="p">)</span>

        <span class="c"># Connect to the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Select all plate IDs from plates that are from the selected</span>
        <span class="c"># locations.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations_selection</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">placeholders</span><span class="p">),</span> <span class="n">locations_selection</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>
        <span class="c">#print &quot;pla_ids: &quot;, pla_ids</span>

        <span class="c"># Select all specie IDs from records with those plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT rec_spe_id FROM records WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) AND rec_spe_id != &#39;&#39;&quot;</span> <span class="o">%</span> <span class="n">pla_ids_str</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">spe_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">spe_ids</span><span class="p">])</span> <span class="c"># Turn the list into a string</span>
        <span class="c">#print &quot;spe_ids: &quot;, spe_ids</span>

        <span class="c"># Select information from species that match those species IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT spe_id, spe_name_venacular, spe_name_latin FROM species WHERE spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">spe_ids_str</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">species</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_record_ids"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_record_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_record_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc_ids</span><span class="p">,</span> <span class="n">spe_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of record IDs that match the localities IDs</span>
<span class="sd">        in the list `loc_ids` and the species IDs in the list `spe_ids`.</span>

<span class="sd">        Design Part: 1.41</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Create strings containing all the selected locations and</span>
        <span class="c"># species IDs. These will be part of the queries below.</span>
        <span class="n">loc_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">loc_ids</span><span class="p">])</span>
        <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">spe_ids</span><span class="p">])</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Get the plate IDs that match the selected locations.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">loc_ids_str</span><span class="p">))</span>

        <span class="c"># Construct a list with the plate IDs.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>

        <span class="c"># Select all record IDs that match the plate IDs and the</span>
        <span class="c"># selected species.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_id FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) &quot;</span>
                        <span class="s">&quot;AND rec_spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">pla_ids_str</span><span class="p">,</span> <span class="n">spe_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Construct a list with the record IDs.</span>
        <span class="n">rec_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">rec_ids</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_spots">[docs]</a>    <span class="k">def</span> <span class="nf">get_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all 25 spot booleans for the records with IDs matching</span>
<span class="sd">        the record IDs in the list `rec_ids`.&quot;&quot;&quot;</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Get all 25 spots from each record that matches the list of</span>
        <span class="c"># record IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">records</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.set_species_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.set_species_spots">[docs]</a>    <span class="k">def</span> <span class="nf">set_species_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table in the local database containing the spots</span>
<span class="sd">        information for SETL records matching `rec_ids`. Two spots</span>
<span class="sd">        tables can be created. The values for `slot` can be ``0`` for table</span>
<span class="sd">        ``species_spots_1`` and ``1`` for ``species_spots_2``.</span>

<span class="sd">        Each record in the spots table consists of the plate ID followed</span>
<span class="sd">        by the 25 spot booleans.</span>

<span class="sd">        Design Part: 1.19.1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># The available tables to save the spots to.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Turn the list into a string, as it&#39;ll be included in the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Make a connection with the local database.</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Empty the required tables before we start.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Get plate ID and all 25 spots from each record that matches</span>
        <span class="c"># the list of record IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                        <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Insert each resulting row in the species_spots table.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span> <span class="n">row</span><span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="AccessRemoteDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessRemoteDB">[docs]</a><span class="k">class</span> <span class="nc">AccessRemoteDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide standard methods for accessing data in the remote</span>
<span class="sd">    PostgreSQL SETL database. These methods are only used when the data</span>
<span class="sd">    source is set to ``setl-database``.</span>

<span class="sd">    Inherits from :class:`AccessDBGeneric` which provides this</span>
<span class="sd">    class with methods that are not data source specific.</span>

<span class="sd">    Design Part: 1.29</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessRemoteDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/setl-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SETLyze v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, GiMaRIS.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>