

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>setlyze.database &mdash; SETLyze 0.3 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SETLyze 0.3 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../gimaris.html">GiMaRIS</a> &raquo;</li>
    
        <li><a href="../../index.html">SETLyze 0.3 documentation</a> &raquo;</li>

          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for setlyze.database</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#  Copyright 2010, 2011, GiMaRIS &lt;info@gimaris.com&gt;</span>
<span class="c">#</span>
<span class="c">#  This file is part of SETLyze - A tool for analyzing the settlement</span>
<span class="c">#  of species on SETL plates.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is free software: you can redistribute it and/or modify</span>
<span class="c">#  it under the terms of the GNU General Public License as published by</span>
<span class="c">#  the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#  (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#  SETLyze is distributed in the hope that it will be useful,</span>
<span class="c">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#  GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#  You should have received a copy of the GNU General Public License</span>
<span class="c">#  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Facilitate access to the database.</span>

<span class="sd">The local SQLite database is created by :meth:`setlyze.database.MakeLocalDB.create_new_db`.</span>
<span class="sd">It is created using Python&#39;s SQLite module and is used internally by SETLyze</span>
<span class="sd">for storing and retrieving data for analyses. The database is a single file</span>
<span class="sd">created in the user&#39;s home directory in a subfolder called ``.setlyze``.</span>

<span class="sd">There are plans to create a central SETL database server which this module</span>
<span class="sd">can interact with. We refer to this database as the remote database.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">dbapi2</span> <span class="k">as</span> <span class="n">sqlite</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">xlrd</span>

<span class="kn">import</span> <span class="nn">gobject</span>

<span class="kn">import</span> <span class="nn">setlyze.config</span>
<span class="kn">import</span> <span class="nn">setlyze.std</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira, Adam van Adrichem, Fedde Schaeffer&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2010, 2011, GiMaRIS&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;GPL3&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.3&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Serrano Pereira&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s">&quot;serrano.pereira@gmail.com&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s">&quot;Production&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s">&quot;2013/02/01&quot;</span>

<span class="c"># The current version of the local database.</span>
<span class="n">DB_VERSION</span> <span class="o">=</span> <span class="mf">0.4</span>

<div class="viewcode-block" id="get_database_accessor"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.get_database_accessor">[docs]</a><span class="k">def</span> <span class="nf">get_database_accessor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return an object that facilitates access to the database.</span>

<span class="sd">    Based on the data source configuration, this function wil either</span>
<span class="sd">    return an instance of :class:`AccessLocalDB` or :class:`AccessRemoteDB`.</span>
<span class="sd">    This instance provides methods that are specific to the data source that</span>
<span class="sd">    is in use.</span>

<span class="sd">    Design Part: 1.93</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_source</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;data-files&#39;</span><span class="p">,</span> <span class="s">&#39;setl-database&#39;</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">AccessLocalDB</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid data source &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">data_source</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>
</div>
<div class="viewcode-block" id="MakeLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB">[docs]</a><span class="k">class</span> <span class="nc">MakeLocalDB</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a local SQLite database with default tables and fill some</span>
<span class="sd">    tables based on the data source.</span>

<span class="sd">    This class can load data from three data sources. One data source is user</span>
<span class="sd">    supplied CSV files containing SETL data. The CSV files must be exported by</span>
<span class="sd">    the MS Access SETL database. The second source is the PostgreSQL SETL</span>
<span class="sd">    database. This function requires a direct connection with the SETL database</span>
<span class="sd">    server. The third source are XLS files containing SETL data. These files</span>
<span class="sd">    must be exported by MS Excel 97/2000/xp.</span>

<span class="sd">    Because the import of SETL data into the local database can take a while,</span>
<span class="sd">    and instance of this class must run in a separate thread. An instance of</span>
<span class="sd">    this class is therefor a thread object.</span>

<span class="sd">    Once a thread object is created, its activity must be started by calling</span>
<span class="sd">    the thread&#39;s start() method. This invokes the :meth:`run` method in a</span>
<span class="sd">    separate thread of control.</span>

<span class="sd">    Design Part: 1.2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MakeLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-source&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">ProgressDialogHandler</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="MakeLocalDB.run"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decide based on the configuration variables which functions should</span>
<span class="sd">        be called.</span>

<span class="sd">        This method first checks if SETLyze is configured to create a new local</span>
<span class="sd">        database. This is done by checking the value of configuration</span>
<span class="sd">        &quot;make-new-db&quot;. If this is set to False, nothing will be done. If set</span>
<span class="sd">        to True, a new local database is created based on the value of the</span>
<span class="sd">        &quot;data-source&quot; configuration:</span>

<span class="sd">        ``setl-database``</span>
<span class="sd">          Method :meth:`insert_from_db` is called and some SETL data from the</span>
<span class="sd">          remote SETL database is loaded into the local database.</span>

<span class="sd">        ``data-files``</span>
<span class="sd">          Method :meth:`insert_from_data_files` is called which loads SETL data</span>
<span class="sd">          from the user supplied data files into the local database.</span>

<span class="sd">        Design Part: 1.31</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Check if we need to make a new database file.</span>
        <span class="k">if</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">):</span>
            <span class="c"># Make sqlite database connection.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c"># Create new database with data.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;setl-database&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_db</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="s">&quot;data-files&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_from_data_files</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Exit gracefully.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;unknown data source &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span>

            <span class="c"># Exit gracefully.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">()</span>

            <span class="c"># Emit the signal that the local database has been created.</span>
            <span class="c"># Note that the signal will be sent from a separate thread,</span>
            <span class="c"># so we must use gobject.idle_add.</span>
            <span class="n">gobject</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="s">&#39;local-db-created&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_data_files"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_data_files">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_data_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database and load all SETL data from user</span>
<span class="sd">        selected CSV or Excel files into the local database.</span>

<span class="sd">        The SETL data is loaded from four separate files:</span>

<span class="sd">        * Locations file, containing the SETL locations.</span>
<span class="sd">        * Species ile, containing the SETL species.</span>
<span class="sd">        * Records file, containing the SETL records.</span>
<span class="sd">        * Plates file, containing the SETL plates.</span>

<span class="sd">        These files can be exported from the MS Access SETL database</span>
<span class="sd">        and contain all fields. CSV files must be delimited by semicolons (;)</span>
<span class="sd">        and double quotes (&quot;) as the quote character for fields with special</span>
<span class="sd">        characters. Excel (*.xls) files must have the same format as the CSV</span>
<span class="sd">        files and must not have a header.</span>

<span class="sd">        Design Part: 1.32</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Loading SETL data from local files...&quot;</span><span class="p">)</span>
        <span class="n">localities_file</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;localities-file&#39;</span><span class="p">)</span>
        <span class="n">plates_file</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;plates-file&#39;</span><span class="p">)</span>
        <span class="n">records_file</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;records-file&#39;</span><span class="p">)</span>
        <span class="n">species_file</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;species-file&#39;</span><span class="p">)</span>

        <span class="c"># If data_source is not set to &quot;data-files&quot;, the required data</span>
        <span class="c"># files are probably not set by the user yet. ChangeDataSource</span>
        <span class="c"># must be called first.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">==</span> <span class="s">&#39;data-files&#39;</span><span class="p">,</span> \
            <span class="s">&quot;The data source is not set to &#39;data-files&#39;&quot;</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Add some meta-data to a separate table in the local database.</span>
        <span class="c"># Add the data source we can figure out what kind of data is</span>
        <span class="c"># present.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c"># Also insert the data of creation, so we can give the user an</span>
        <span class="c"># indication when this database was created.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># Set the total number of times we&#39;re going to update the progress</span>
        <span class="c"># dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">set_total_steps</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c"># Insert the data from the data files into the local database.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">localities_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">set_action</span><span class="p">(</span><span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">localities_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.xls&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_locations_from_xls</span><span class="p">(</span><span class="n">localities_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_locations_from_csv</span><span class="p">(</span><span class="n">localities_file</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">plates_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plates_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.xls&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_plates_from_xls</span><span class="p">(</span><span class="n">plates_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_plates_from_csv</span><span class="p">(</span><span class="n">plates_file</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">records_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">records_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.xls&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_records_from_xls</span><span class="p">(</span><span class="n">records_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_records_from_csv</span><span class="p">(</span><span class="n">records_file</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">species_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="s">&quot;Importing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">species_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.xls&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_species_from_xls</span><span class="p">(</span><span class="n">species_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_species_from_csv</span><span class="p">(</span><span class="n">species_file</span><span class="p">)</span>

            <span class="c"># Commit the database changes.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Destroy the progress dialog.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="c"># Rollback changes to the database.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="c"># Emit the signal that the import failed.</span>
            <span class="n">gobject</span><span class="o">.</span><span class="n">idle_add</span><span class="p">(</span><span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="s">&#39;file-import-failed&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># If we are here, the import was successful.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_locations_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_locations_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_locations_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the SETL localities from a CSV file into the local</span>
<span class="sd">        database.</span>

<span class="sd">        Argument `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file, and `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file. The default</span>
<span class="sd">        values for these two arguments are suited for CSV files in Excel</span>
<span class="sd">        format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.18`.</span>

<span class="sd">        Design Part: 1.34</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing localities data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 5 fields per row for the &quot;</span>
                    <span class="s">&quot;localities CSV file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO localities VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_species_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_species_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_species_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the species from a CSV file into the local database.</span>

<span class="sd">        Argument `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file, and `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file. The default</span>
<span class="sd">        values for these two arguments are suited for CSV files in Excel</span>
<span class="sd">        format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.19`.</span>

<span class="sd">        Design Part: 1.35</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing species data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 16 fields per row for the &quot;</span>
                    <span class="s">&quot;species CSV file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

            <span class="n">row_new</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">row_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;FALSE&#39;</span><span class="p">:</span>
                        <span class="n">row_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;TRUE&#39;</span><span class="p">:</span>
                        <span class="n">row_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">row_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

            <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO species VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="n">placeholders</span><span class="p">,</span>
                <span class="n">row_new</span>
            <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_plates_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_plates_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_plates_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the plates from a CSV file into the local database.</span>

<span class="sd">        Argument `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file, and `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file. The default</span>
<span class="sd">        values for these two arguments are suited for CSV files in Excel</span>
<span class="sd">        format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.20`.</span>

<span class="sd">        Design Part: 1.36</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing plates data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 10 fields per row for the &quot;</span>
                    <span class="s">&quot;plates CSV file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO plates VALUES (?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_records_from_csv"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_records_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">insert_records_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the records from a CSV file into the local database.</span>

<span class="sd">        Argument `delimiter` is a one-character string used to separate fields</span>
<span class="sd">        in the CSV file, and `quotechar` is a one-character string used to</span>
<span class="sd">        quote fields containing special characters in the CSV file. The default</span>
<span class="sd">        values for these two arguments are suited for CSV files in Excel</span>
<span class="sd">        format.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.21`.</span>

<span class="sd">        Design Part: 1.37</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing records data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the CSV file.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s CSV module to create a CSV reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="n">quotechar</span><span class="p">)</span>

        <span class="c"># Read through every row in the CSV file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">38</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">setl_reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 40 fields per row for the &quot;</span>
                    <span class="s">&quot;plates CSV file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO records VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">placeholders</span><span class="p">,</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">26</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">27</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">33</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="mi">37</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_locations_from_xls"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_locations_from_xls">[docs]</a>    <span class="k">def</span> <span class="nf">insert_locations_from_xls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the SETL localities from a XLS file into the local</span>
<span class="sd">        database.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.18`.</span>

<span class="sd">        Design Part: TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing localities data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the XLS file.</span>
        <span class="n">f</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s xlrd module to create a XLS reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Read through every row in the XLS file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 5 fields per row for the &quot;</span>
                    <span class="s">&quot;localities XLS file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO localities VALUES (?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_plates_from_xls"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_plates_from_xls">[docs]</a>    <span class="k">def</span> <span class="nf">insert_plates_from_xls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the plates from a XLS file into the local database.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.20`.</span>

<span class="sd">        Design Part: TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing plates data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the XLS file.</span>
        <span class="n">f</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s xlrd module to create a XLS reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Read through every row in the XLS file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 10 fields per row for the &quot;</span>
                    <span class="s">&quot;plates xls file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO plates VALUES (?,?,?,?,?,?,?,?,?,?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">4</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">5</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">6</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">7</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">8</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">9</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_records_from_xls"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_records_from_xls">[docs]</a>    <span class="k">def</span> <span class="nf">insert_records_from_xls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the records from a XLS file into the local database.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.21`.</span>

<span class="sd">        Design Part: TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing records data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the XLS file.</span>
        <span class="n">f</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s xlrd module to create a XLS reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Read through every row in the xls file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">38</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting 40 fields per row for the &quot;</span>
                    <span class="s">&quot;plates XLS file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO records VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">placeholders</span><span class="p">,</span>
                <span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">4</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">5</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">6</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">7</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">8</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">9</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">10</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">11</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">12</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">13</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">14</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">15</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">16</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">17</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">18</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">19</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">20</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">21</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">22</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">23</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">24</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">25</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">26</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">27</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">28</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">29</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">30</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">31</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">32</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">33</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">34</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">35</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">36</span><span class="p">],</span>
                 <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="mi">37</span><span class="p">])</span>
                <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_species_from_xls"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_species_from_xls">[docs]</a>    <span class="k">def</span> <span class="nf">insert_species_from_xls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the species from a XLS file into the local database.</span>

<span class="sd">        For a description of the format for the localities file, refer</span>
<span class="sd">        to :ref:`design-part-data-2.19`.</span>

<span class="sd">        Design Part: 1.35(b) TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Importing species data from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># Try to open the XLS file.</span>
        <span class="n">f</span><span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Use Python&#39;s xlrd module to create a XLS reader.</span>
        <span class="n">setl_reader</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Read through every row in the XLS file and insert that row</span>
        <span class="c"># into the local database.</span>
        <span class="k">for</span> <span class="n">rownum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Expecting at most 16 fields per row for the &quot;</span>
                    <span class="s">&quot;species XLS file, found </span><span class="si">%d</span><span class="s"> fields.&quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

            <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">setl_reader</span><span class="o">.</span><span class="n">row_values</span><span class="p">(</span><span class="n">rownum</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO species VALUES (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="n">placeholders</span><span class="p">,</span>
                <span class="n">row</span>
            <span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.insert_from_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.insert_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">insert_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database and load localities and species</span>
<span class="sd">        data from the remote SETL database into the local database.</span>

<span class="sd">        This method requires a direct connection with the SETL</span>
<span class="sd">        database server.</span>

<span class="sd">        The reason why we don&#39;t load all SETL data into the local database</span>
<span class="sd">        is because we can execute queries on the remote database. So</span>
<span class="sd">        there&#39;s no need to load large amounts of data onto the user&#39;s</span>
<span class="sd">        computer. Because the localities and species data is accessed</span>
<span class="sd">        often, loading this into the local database increases speed of</span>
<span class="sd">        the application.</span>

<span class="sd">        Design Part: 1.33</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating local database from SETL database...&quot;</span><span class="p">)</span>

        <span class="c"># Set the total number of times we&#39;re going to update the progress</span>
        <span class="c"># dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">set_total_steps</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c"># First, create a new database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_new_db</span><span class="p">()</span>

        <span class="c"># Update progress dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">()</span>

        <span class="c"># Next time we run the tool, we&#39;ll know what data is in the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;source&#39;, ?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">,)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO info VALUES (null, &#39;date&#39;, date(&#39;now&#39;))&quot;</span> <span class="p">)</span>

        <span class="c"># Commit the transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># TODO: Actually insert data from SETL database.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Loading data from the remote SETL database...&quot;</span><span class="p">)</span>

        <span class="c"># Update progress dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdialog_handler</span><span class="o">.</span><span class="n">increase</span><span class="p">()</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Local database populated.&quot;</span><span class="p">)</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;has-local-db&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_new_db"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_new_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_new_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new local database.</span>

<span class="sd">        This deletes any existing database file.</span>

<span class="sd">        Design Part: 1.38</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating new local database file...&quot;</span><span class="p">)</span>

        <span class="c"># Check if the data folder exists. If not, create it.</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data-path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Creating data folder </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

        <span class="c"># Delete the current database file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_db_file</span><span class="p">()</span>

        <span class="c"># Create a new database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Create the tables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_localities</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_species</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_plates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_table_records</span><span class="p">()</span>

        <span class="c"># Commit the transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># No need to make a new database, as we just created one.</span>
        <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;make-new-db&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.remove_db_file"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.remove_db_file">[docs]</a>    <span class="k">def</span> <span class="nf">remove_db_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the database file.</span>

<span class="sd">        This method does three tries if for some reason the database file</span>
<span class="sd">        could not be deleted (e.g. the file is in use by a different process).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s">&quot;Failed to delete database file </span><span class="si">%s</span><span class="s">. &quot;</span>
                <span class="s">&quot;It may be in use by a different process.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_db_file</span><span class="p">(</span><span class="n">tries</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_info"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_info">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &quot;info&quot; table for storing general information.</span>

<span class="sd">        This information includes its creation date and the data source.</span>
<span class="sd">        The data source is either the SETL database (MS Access/PostgreSQL)</span>
<span class="sd">        or XLS/CSV files containing SETL data. A version number for the</span>
<span class="sd">        database is also saved. This could be handy in the future,</span>
<span class="sd">        for example we can notify the user if the local database is</span>
<span class="sd">        too old, followed by creating a new local database.</span>

<span class="sd">        Design Part: 1.75</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE info (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            name VARCHAR, </span><span class="se">\</span>
<span class="s">            value VARCHAR)&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO info &quot;</span>
            <span class="s">&quot;VALUES (null, &#39;version&#39;, ?)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">DB_VERSION</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_localities"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_localities">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_localities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &quot;localities&quot; table for the SETL locations.</span>

<span class="sd">        Because the data from this table is accessed frequently, the</span>
<span class="sd">        localities records are automatically saved to this table when</span>
<span class="sd">        an analyze is started.</span>

<span class="sd">        Design Part: 1.76</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Design Part: 2.4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE localities (</span><span class="se">\</span>
<span class="s">            loc_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            loc_name VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_nr VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_coordinates VARCHAR, </span><span class="se">\</span>
<span class="s">            loc_description VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_species"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_species">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &quot;species&quot; table for the SETL species.</span>

<span class="sd">        Because the data from this table is accessed frequently, the</span>
<span class="sd">        species records are automatically saved to this table when</span>
<span class="sd">        an analyze is started.</span>

<span class="sd">        Design Part: 1.77</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE species (</span><span class="se">\</span>
<span class="s">            spe_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            spe_aphia_id INTEGER, </span><span class="se">\</span>
<span class="s">            spe_name_venacular VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_name_latin VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_invasive_in_nl INTEGER, </span><span class="se">\</span>
<span class="s">            spe_description VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_remarks VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_kingdom VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_phylum VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_class VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_order VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_family VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_genus VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_subgenus VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_species VARCHAR, </span><span class="se">\</span>
<span class="s">            spe_subspecies VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_plates"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_plates">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &quot;plates&quot; table for the SETL plates.</span>

<span class="sd">        This table is only filled if the user selected CSV or XLS files to</span>
<span class="sd">        import SETL data from. If the remote SETL database is used,</span>
<span class="sd">        the plate records are obtained directly via queries.</span>

<span class="sd">        Design Part: 1.78</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Design Part: 2.16</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE plates (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            pla_loc_id INTEGER, </span><span class="se">\</span>
<span class="s">            pla_setl_coordinator VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_nr VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_deployment_date TEXT, </span><span class="se">\</span>
<span class="s">            pla_retrieval_date TEXT, </span><span class="se">\</span>
<span class="s">            pla_water_temperature VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_salinity VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_visibility VARCHAR, </span><span class="se">\</span>
<span class="s">            pla_remarks VARCHAR </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MakeLocalDB.create_table_records"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.MakeLocalDB.create_table_records">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the &quot;records&quot; table for the SETL records.</span>

<span class="sd">        This table is only filled if the user selected CSV or XLS files to</span>
<span class="sd">        import SETL data from. If the remote SETL database is used,</span>
<span class="sd">        the records are obtained directly via queries.</span>

<span class="sd">        Design Part: 1.79</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part: 2.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE records (</span><span class="se">\</span>
<span class="s">            rec_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_spe_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_unknown INTEGER, </span><span class="se">\</span>
<span class="s">            rec_o INTEGER, </span><span class="se">\</span>
<span class="s">            rec_r INTEGER, </span><span class="se">\</span>
<span class="s">            rec_c INTEGER, </span><span class="se">\</span>
<span class="s">            rec_a INTEGER, </span><span class="se">\</span>
<span class="s">            rec_e INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur_unknown INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_1st INTEGER, </span><span class="se">\</span>
<span class="s">            rec_2nd INTEGER, </span><span class="se">\</span>
<span class="s">            rec_v INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AccessDBGeneric"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric">[docs]</a><span class="k">class</span> <span class="nc">AccessDBGeneric</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Super class for :class:`AccessLocalDB` and :class:`AccessRemoteDB`.</span>

<span class="sd">    This class contains methods that are generic for both sub-classes.</span>
<span class="sd">    It provides both sub classes with methods for data that is always</span>
<span class="sd">    present in the local database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_dialog</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db-file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<div class="viewcode-block" id="AccessDBGeneric.get_database_info"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_database_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_database_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return database information.</span>

<span class="sd">        These include the creation date and the data source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT name,value FROM info;&quot;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Some types need to be converted from string.</span>
        <span class="n">to_float</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">to_float</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">info</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_locations"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_locations">[docs]</a>    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all locations from the local database.</span>

<span class="sd">        Returns a list of tuples ``(loc_id, &#39;loc_name&#39;)``.</span>

<span class="sd">        Design Part: 1.95</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT loc_id, loc_name FROM localities&quot;</span><span class="p">)</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">locations</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.make_plates_unique"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.make_plates_unique">[docs]</a>    <span class="k">def</span> <span class="nf">make_plates_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combine the records with the same plate ID in a spots table.</span>

<span class="sd">        The value for `slot` defines which spots table is used.</span>
<span class="sd">        The possible values of `slot` are ``0`` for table</span>
<span class="sd">        &quot;species_spots_1&quot; and ``1`` for table &quot;species_spots_2&quot;.</span>

<span class="sd">        We&#39;re doing this so we can threat multiple species selected by</span>
<span class="sd">        the user as a single species.</span>

<span class="sd">        Returns the total numbers of distinctive plates.</span>

<span class="sd">        Design Part: 1.20</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Get all distinctive plate IDs.</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT DISTINCT rec_pla_id FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pla_id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">:</span>
            <span class="c"># Get plate ID and all 25 spots for each plate ID.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                            <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                            <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                            <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                            <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                            <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
            <span class="p">)</span>

            <span class="c"># Create a combined record from all records with this plate ID.</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="c"># No need to do anything if there is just one record for a plate.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c"># Remove all records with that plate ID from the species_spots table.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id = ?&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">pla_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
            <span class="p">)</span>

            <span class="c"># Insert the combined record in the species_spots table. So this</span>
            <span class="c"># single record replaces all other records with this plate ID.</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">combine_records</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span>
                            <span class="n">combined</span>
            <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the total numbers of unique plate records.</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.fill_plate_spot_totals_table"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.fill_plate_spot_totals_table">[docs]</a>    <span class="k">def</span> <span class="nf">fill_plate_spot_totals_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate table &quot;plate_spot_totals&quot;.</span>

<span class="sd">        This table is populated with the number of positive spots for each</span>
<span class="sd">        plate. The information is obtained from the spots tables `spots_table1`</span>
<span class="sd">        and optionally `spots_table2`.</span>

<span class="sd">        The &quot;plate_spot_totals&quot; table is used in several situations:</span>

<span class="sd">            * Calculating the expected distances, where the positive spot</span>
<span class="sd">              number serves as a template for the random spots generator</span>
<span class="sd">              (see :meth:`~setlyze.std.get_random_for_plate`).</span>

<span class="sd">            * Significance calculators, where the tests are applied to</span>
<span class="sd">              plates with a specific number of positive spots (see</span>
<span class="sd">              :meth:`get_distances_matching_spots_total`).</span>

<span class="sd">        If just `spots_table1` is provided, only the column &quot;n_spots_a&quot;</span>
<span class="sd">        is populated with positive spot numbers. If both `spots_table1` and</span>
<span class="sd">        `spots_table2` are provided, column &quot;n_spots_a&quot; is filled</span>
<span class="sd">        from `spots_table1`, and column &quot;n_spots_b&quot; filled from `spots_table2`.</span>

<span class="sd">        Returns a tuple (`rows affected`, `rows skipped`).</span>

<span class="sd">        Design Part: 1.73</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Empty the plate_spot_totals table before we use it again.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DELETE FROM plate_spot_totals&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rowcount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">spots_table2</span><span class="p">:</span>
            <span class="c"># Two spots tables are provided.</span>

            <span class="c"># Get all records from both spots tables where the plate IDs</span>
            <span class="c"># match.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25|id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|</span>
            <span class="c"># rec_sur4|rec_sur5|rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|</span>
            <span class="c"># rec_sur11|rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|</span>
            <span class="c"># rec_sur17|rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|</span>
            <span class="c"># rec_sur23|rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT s1.*, s2.* FROM </span><span class="si">%s</span><span class="s"> as s1 &quot;</span>
                            <span class="s">&quot;INNER JOIN </span><span class="si">%s</span><span class="s"> as s2 &quot;</span>
                            <span class="s">&quot;ON s1.rec_pla_id=s2.rec_pla_id&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_table1</span><span class="p">,</span> <span class="n">spots_table2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">record1</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span>
                <span class="n">record2</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>
                <span class="n">plate_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c"># Get the positive spots for both records.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record2</span><span class="p">)</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots1</span><span class="p">)</span>
                <span class="n">spots2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots2</span><span class="p">)</span>

                <span class="c"># Skip this plate if both records contain less than 1 positive</span>
                <span class="c"># spot. We won&#39;t be able to calculate distances for such</span>
                <span class="c"># records anyway.</span>
                <span class="k">if</span> <span class="n">spots1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spots2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the plate_spot_totals</span>
                <span class="c"># table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,?)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">plate_id</span><span class="p">,</span> <span class="n">spots1</span><span class="p">,</span> <span class="n">spots2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">rowcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># One spots table is provided.</span>

            <span class="c"># Get all spots for each plate.</span>
            <span class="c"># Each returned record has this format:</span>
            <span class="c"># id|rec_pla_id|rec_sur1|rec_sur2|rec_sur3|rec_sur4|rec_sur5|</span>
            <span class="c"># rec_sur6|rec_sur7|rec_sur8|rec_sur9|rec_sur10|rec_sur11|</span>
            <span class="c"># rec_sur12|rec_sur13|rec_sur14|rec_sur15|rec_sur16|rec_sur17|</span>
            <span class="c"># rec_sur18|rec_sur19|rec_sur20|rec_sur21|rec_sur22|rec_sur23|</span>
            <span class="c"># rec_sur24|rec_sur25</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">spots_table1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">plate_id</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="c"># Get the positive spots for this record.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">get_spots_from_record</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                <span class="c"># We&#39;re only interested in the number of spots.</span>
                <span class="n">spots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spots</span><span class="p">)</span>

                <span class="c"># Skip this record if it contains less than 2 positive spots.</span>
                <span class="c"># We won&#39;t be able to calculate a distance for such records</span>
                <span class="c"># anyway.</span>
                <span class="k">if</span> <span class="n">spots</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="c"># Save the number of positive spots to the plate_spot_totals</span>
                <span class="c"># table.</span>
                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;INSERT INTO plate_spot_totals &quot;</span>
                                 <span class="s">&quot;VALUES (?,?,null)&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">plate_id</span><span class="p">,</span> <span class="n">spots</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">rowcount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Commit the transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Return the number of (rows affected, rows skipped)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rowcount</span><span class="p">,</span> <span class="n">skipped</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_distances_matching_spots_total"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_distances_matching_spots_total">[docs]</a>    <span class="k">def</span> <span class="nf">get_distances_matching_spots_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance_table</span><span class="p">,</span> <span class="n">spots_n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the distances from distance table `distance_table` that</span>
<span class="sd">        are from plates having `spots_n` positive spot numbers.</span>

<span class="sd">        This is a generator, meaning that this method returns an</span>
<span class="sd">        iterator. This iterator returns the distances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">spots_n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># If spots_n is a negative number, get all distances</span>
            <span class="c"># up to the absolute number. So if we find -5, get all</span>
            <span class="c"># distances up to 5.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT distance FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">distance_table</span><span class="p">)</span>

            <span class="c"># Get the plate IDs that have n spots lower or equal to the</span>
            <span class="c"># absolute spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a &lt;= </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">spots_n</span><span class="p">))</span>
                            <span class="p">)</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">plate_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

            <span class="c"># Get the distances that match the plate IDs.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids_str</span><span class="p">)</span>
                            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the plate IDs that match the provided total spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">spots_n</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="n">plate_ids</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">plate_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

            <span class="c"># Get the distances that match the plate IDs.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                            <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                            <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids_str</span><span class="p">)</span>
                            <span class="p">)</span>

        <span class="c"># Save the number of matching plates. Note that this variable can only</span>
        <span class="c"># be called after the iter that this generator returns was used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matching_plates_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plate_ids</span><span class="p">)</span>

        <span class="c"># Return all matching distances.</span>
        <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_distances_matching_ratios"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_distances_matching_ratios">[docs]</a>    <span class="k">def</span> <span class="nf">get_distances_matching_ratios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance_table</span><span class="p">,</span> <span class="n">ratios</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spot distances from distance table `distance_table` where</span>
<span class="sd">        positive spots numbers between species A and B have ratio</span>
<span class="sd">        matching the list of ratios `ratios`.</span>

<span class="sd">        The ratio A:B is considered the same as B:A.</span>

<span class="sd">        This is a generator, meaning that this method returns an</span>
<span class="sd">        iterator. This iterator returns the distances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">plate_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">ratios</span><span class="p">:</span>
            <span class="c"># Get the plate IDs that match the ratio A:B.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s"> &quot;</span>
                            <span class="s">&quot;AND n_spots_b = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>

            <span class="c"># Add the plate IDs to the list of plate IDs.</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="n">plate_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

            <span class="c"># We need the complement ratio B:A as well, so we get the</span>
            <span class="c"># plate IDs for the complement as well.</span>

            <span class="c"># No need to get the complement ratio if it&#39;s the same.</span>
            <span class="k">if</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c"># Get the plate IDs that match the complement ratio B:A.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT pla_id &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE n_spots_a = </span><span class="si">%d</span><span class="s"> &quot;</span>
                            <span class="s">&quot;AND n_spots_b = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="p">)</span>

            <span class="c"># Add the plate IDs to the list of plate IDs.</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="n">plate_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="c"># Save the number of matching plates. Note that this variable can only</span>
        <span class="c"># be called after the iter that this generator returns was used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matching_plates_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plate_ids</span><span class="p">)</span>

        <span class="c"># Turn the list of plate IDs into a string.</span>
        <span class="n">plate_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plate_ids</span><span class="p">])</span>

        <span class="c"># Get the distances that match the plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT distance &quot;</span>
                        <span class="s">&quot;FROM </span><span class="si">%s</span><span class="s"> &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">distance_table</span><span class="p">,</span> <span class="n">plate_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Return all matching distances.</span>
        <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_area_totals"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_area_totals">[docs]</a>    <span class="k">def</span> <span class="nf">get_area_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plate_area_totals_table</span><span class="p">,</span> <span class="n">area_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return total number of positive spots per area group per plate.</span>

<span class="sd">        Argument `plate_area_totals_table` is either</span>
<span class="sd">        ``plate_area_totals_observed`` or ``plate_area_totals_expected``.</span>
<span class="sd">        The area group `area_group` can be a sequence containing a</span>
<span class="sd">        combination of the letters A, B, C, and D. Each letter is one of</span>
<span class="sd">        the default areas on a SETL plate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Compile a string containing the area fields for &#39;area_group&#39;.</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">area</span> <span class="ow">in</span> <span class="n">area_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;area_a&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">area</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;area_b&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">area</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;area_c&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">area</span> <span class="o">==</span> <span class="s">&#39;D&#39;</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;area_d&#39;</span><span class="p">)</span>
        <span class="n">fields_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="c"># Get the area totals for the areas in area group.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT </span><span class="si">%s</span><span class="s"> FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">fields_str</span><span class="p">,</span> <span class="n">plate_area_totals_table</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># We&#39;re dealing with combined areas, so we will return the total of</span>
            <span class="c"># the areas combined.</span>
            <span class="k">for</span> <span class="n">totals</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">totals</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">t</span>
                <span class="k">yield</span> <span class="n">total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># One field, so one total is returned per row.</span>
            <span class="k">for</span> <span class="n">total</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Close connection with the local database.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AccessDBGeneric.get_plates_total_matching_spots_total"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessDBGeneric.get_plates_total_matching_spots_total">[docs]</a>    <span class="k">def</span> <span class="nf">get_plates_total_matching_spots_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_spots</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of plates that match the provided number of</span>
<span class="sd">        positive spots `n_spots`.</span>

<span class="sd">        Possible values for `slot` are 0 for the first species selection,</span>
<span class="sd">        and 1 for the second species selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">slot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;n_spots_a&#39;</span>
        <span class="k">elif</span> <span class="n">slot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;n_spots_b&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Possible values for &#39;slot&#39; are 0 and 1.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_spots</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># If spots_n is a negative number, get all distances</span>
            <span class="c"># up to the absolute number. So if we find -5, get all</span>
            <span class="c"># distances with up to 5 spots.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT COUNT(pla_id) &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE </span><span class="si">%s</span><span class="s"> &lt;= ?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">),</span>
                            <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">n_spots</span><span class="p">)])</span>
            <span class="n">n_plates</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If it&#39;s a positive number, just get the plates that</span>
            <span class="c"># match that spots number.</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT COUNT(pla_id) &quot;</span>
                            <span class="s">&quot;FROM plate_spot_totals &quot;</span>
                            <span class="s">&quot;WHERE </span><span class="si">%s</span><span class="s"> = ?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">),</span>
                            <span class="p">[</span><span class="n">n_spots</span><span class="p">])</span>
            <span class="n">n_plates</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">n_plates</span>
</div></div>
<div class="viewcode-block" id="AccessLocalDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB">[docs]</a><span class="k">class</span> <span class="nc">AccessLocalDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide standard methods for accessing data in the local</span>
<span class="sd">    SQLite database. These methods are only used when the data source</span>
<span class="sd">    is set to ``data-files``.</span>

<span class="sd">    Inherits from :class:`AccessDBGeneric` which provides this</span>
<span class="sd">    class with methods that are not data source specific.</span>

<span class="sd">    Design Part: 1.28</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessLocalDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="AccessLocalDB.create_table_species_spots_1"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_species_spots_1">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species_spots_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;species_spots_1&quot;.</span>

<span class="sd">        This table will contain the SETL records for the first species</span>
<span class="sd">        selection.</span>

<span class="sd">        Because the user can select multiple species, the plate IDs in column</span>
<span class="sd">        &quot;rec_pla_id&quot; don&#39;t have to be unique, so we&#39;re creating a separate</span>
<span class="sd">        column &quot;id&quot; as the primary key.</span>

<span class="sd">        Design Part: 1.80</span>
<span class="sd">        Creates Design Part: 2.9, 2.9.1, 2.9.2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE species_spots_1 (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_species_spots_2"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_species_spots_2">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_species_spots_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;species_spots_2&quot;.</span>

<span class="sd">        This table will contain the SETL records for the second species</span>
<span class="sd">        selection.</span>

<span class="sd">        Because the user can select multiple species, the plate IDs in column</span>
<span class="sd">         &quot;rec_pla_id&quot; don&#39;t have to be unique, so we&#39;re creating a separate</span>
<span class="sd">         column &quot;id&quot; as the primary key.</span>

<span class="sd">        Design Part: 1.81</span>
<span class="sd">        Creates Design Part: 2.10, 2.10.1, 2.10.2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE species_spots_2 (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur1 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur2 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur3 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur4 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur5 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur6 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur7 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur8 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur9 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur10 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur11 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur12 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur13 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur14 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur15 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur16 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur17 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur18 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur19 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur20 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur21 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur22 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur23 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur24 INTEGER, </span><span class="se">\</span>
<span class="s">            rec_sur25 INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_spot_distances_observed"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_spot_distances_observed">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_spot_distances_observed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;spot_distances_observed&quot;.</span>

<span class="sd">        This table is used to store observed spot distances.</span>

<span class="sd">        Design Part: 1.83</span>
<span class="sd">        Creates Design Part: 2.12</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE spot_distances_observed (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            distance REAL </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_spot_distances_expected"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_spot_distances_expected">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_spot_distances_expected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;spot_distances_expected&quot;.</span>

<span class="sd">        This table is used to store expected spot distances.</span>

<span class="sd">        Design Part: 1.84</span>
<span class="sd">        Creates Design Part: 2.13</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE spot_distances_expected (</span><span class="se">\</span>
<span class="s">            id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            rec_pla_id INTEGER, </span><span class="se">\</span>
<span class="s">            distance REAL </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_plate_spot_totals"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_plate_spot_totals">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plate_spot_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;plate_spot_totals&quot;.</span>

<span class="sd">        This table is used to store the total of spots per plate.</span>

<span class="sd">        Design Part: 1.85</span>
<span class="sd">        Creates Design Part: 2.39</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE plate_spot_totals (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            n_spots_a INTEGER, </span><span class="se">\</span>
<span class="s">            n_spots_b INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_plate_area_totals_observed"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_plate_area_totals_observed">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plate_area_totals_observed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;plate_area_totals_observed&quot;.</span>

<span class="sd">        This table is used to store the total of positive spots per plate area</span>
<span class="sd">        per plate ID.</span>

<span class="sd">        Design Part:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Design Part:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE plate_area_totals_observed (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            area_a INTEGER, </span><span class="se">\</span>
<span class="s">            area_b INTEGER, </span><span class="se">\</span>
<span class="s">            area_c INTEGER, </span><span class="se">\</span>
<span class="s">            area_d INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.create_table_plate_area_totals_expected"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.create_table_plate_area_totals_expected">[docs]</a>    <span class="k">def</span> <span class="nf">create_table_plate_area_totals_expected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary table &quot;plate_area_totals_expected&quot;.</span>

<span class="sd">        This table is used to store the total of expected positive spots per</span>
<span class="sd">        plate area per plate ID.</span>

<span class="sd">        Design Part: TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TEMP TABLE plate_area_totals_expected (</span><span class="se">\</span>
<span class="s">            pla_id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="s">            area_a INTEGER, </span><span class="se">\</span>
<span class="s">            area_b INTEGER, </span><span class="se">\</span>
<span class="s">            area_c INTEGER, </span><span class="se">\</span>
<span class="s">            area_d INTEGER </span><span class="se">\</span>
<span class="s">        )&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_species"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_species">[docs]</a>    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return species that match a locations selection `locations`.</span>

<span class="sd">        Species are returned as tuples in the format</span>
<span class="sd">        ``(id, &#39;common_name&#39;, &#39;latin_name&#39;)``. Argument `locations` is a list</span>
<span class="sd">        of location IDs.</span>

<span class="sd">        Design Part: 1.96</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># Select all plate IDs from plates that are from the selected</span>
        <span class="c"># locations.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">locations</span><span class="p">))</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">placeholders</span><span class="p">),</span> <span class="n">locations</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">pla_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>

        <span class="c"># Select all species IDs from records with those plate IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT rec_spe_id FROM records WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) AND rec_spe_id != &#39;&#39;&quot;</span> <span class="o">%</span> <span class="n">pla_ids_str</span><span class="p">)</span>
        <span class="c"># Construct a list with the IDs</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="c"># Remove duplicates.</span>
        <span class="n">spe_ids</span> <span class="o">=</span> <span class="n">setlyze</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">uniqify</span><span class="p">(</span><span class="n">spe_ids</span><span class="p">)</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">spe_ids</span><span class="p">])</span> <span class="c"># Turn the list into a string</span>
        <span class="c">#print &quot;spe_ids: &quot;, spe_ids</span>

        <span class="c"># Select information from species that match those species IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT spe_id,spe_name_venacular,spe_name_latin,&quot;</span>
            <span class="s">&quot;spe_invasive_in_nl,spe_phylum,spe_class,spe_order,spe_family,&quot;</span>
            <span class="s">&quot;spe_genus FROM species WHERE spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">spe_ids_str</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">species</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_record_ids"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_record_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_record_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return records that match the locations and species selections.</span>

<span class="sd">        Returns a list of record IDs that match the locations IDs</span>
<span class="sd">        in the list `locations` and the species IDs in the list `species`.</span>

<span class="sd">        Both `locations` and `species` can be an integer instead of a list with</span>
<span class="sd">        a single integer.</span>

<span class="sd">        Design Part: 1.41</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Create strings containing all the selected locations and</span>
        <span class="c"># species IDs. These will be part of the queries below.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">loc_ids_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spe_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">species</span><span class="p">])</span>

        <span class="c"># Get the plate IDs that match the selected locations.</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT pla_id FROM plates WHERE pla_loc_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">loc_ids_str</span><span class="p">))</span>

        <span class="c"># Construct a list with the plate IDs.</span>
        <span class="n">pla_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>
        <span class="n">pla_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pla_ids</span><span class="p">])</span>

        <span class="c"># Select all record IDs that match the plate IDs and the</span>
        <span class="c"># selected species.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_id FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_pla_id IN (</span><span class="si">%s</span><span class="s">) &quot;</span>
                        <span class="s">&quot;AND rec_spe_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">pla_ids_str</span><span class="p">,</span> <span class="n">spe_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Construct a list with the record IDs.</span>
        <span class="n">rec_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">]</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rec_ids</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.get_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.get_spots">[docs]</a>    <span class="k">def</span> <span class="nf">get_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all 25 spot booleans for the records with IDs matching</span>
<span class="sd">        the list of record IDs `rec_ids`.</span>

<span class="sd">        This is a generator, meaning that this method returns an</span>
<span class="sd">        iterator. This iterator returns tuples with the 25 spot booleans for</span>
<span class="sd">        all matching records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Create a string of the IDs for the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Get all 25 spots from each record that matches the list of</span>
        <span class="c"># record IDs.</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">record</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AccessLocalDB.set_species_spots"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessLocalDB.set_species_spots">[docs]</a>    <span class="k">def</span> <span class="nf">set_species_spots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec_ids</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a table in the local database containing the spots</span>
<span class="sd">        information for SETL records matching `rec_ids`. Two spots</span>
<span class="sd">        tables can be created. The values for `slot` can be ``0`` for table</span>
<span class="sd">        ``species_spots_1`` and ``1`` for ``species_spots_2``.</span>

<span class="sd">        Each record in the spots table consists of the plate ID followed</span>
<span class="sd">        by the 25 spot booleans.</span>

<span class="sd">        Design Part: 1.19.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c"># The available tables to save the spots to.</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;species_spots_1&#39;</span><span class="p">,</span><span class="s">&#39;species_spots_2&#39;</span><span class="p">)</span>

        <span class="c"># Turn the list into a string, as it&#39;ll be included in the query.</span>
        <span class="n">rec_ids_str</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rec_ids</span><span class="p">])</span>

        <span class="c"># Empty the required tables before we start.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;DELETE FROM </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Get plate ID and all 25 spots from each record that matches</span>
        <span class="c"># the list of record IDs.</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span> <span class="s">&quot;SELECT rec_pla_id,&quot;</span>
                        <span class="s">&quot;rec_sur1,rec_sur2,rec_sur3,rec_sur4,rec_sur5,&quot;</span>
                        <span class="s">&quot;rec_sur6,rec_sur7,rec_sur8,rec_sur9,rec_sur10,&quot;</span>
                        <span class="s">&quot;rec_sur11,rec_sur12,rec_sur13,rec_sur14,rec_sur15,&quot;</span>
                        <span class="s">&quot;rec_sur16,rec_sur17,rec_sur18,rec_sur19,rec_sur20,&quot;</span>
                        <span class="s">&quot;rec_sur21,rec_sur22,rec_sur23,rec_sur24,rec_sur25 &quot;</span>
                        <span class="s">&quot;FROM records &quot;</span>
                        <span class="s">&quot;WHERE rec_id IN (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">rec_ids_str</span><span class="p">)</span>
                        <span class="p">)</span>

        <span class="c"># Insert each resulting row in the species_spots table.</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;?&#39;</span> <span class="o">*</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;INSERT INTO </span><span class="si">%s</span><span class="s"> VALUES (null,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span> <span class="n">placeholders</span><span class="p">),</span> <span class="n">row</span><span class="p">)</span>

        <span class="c"># Commit the database transaction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div></div>
<div class="viewcode-block" id="AccessRemoteDB"><a class="viewcode-back" href="../../setlyze/database.html#setlyze.database.AccessRemoteDB">[docs]</a><span class="k">class</span> <span class="nc">AccessRemoteDB</span><span class="p">(</span><span class="n">AccessDBGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide standard methods for accessing data in the remote</span>
<span class="sd">    PostgreSQL SETL database. These methods are only used when the data</span>
<span class="sd">    source is set to ``setl-database``.</span>

<span class="sd">    Inherits from :class:`AccessDBGeneric` which provides this</span>
<span class="sd">    class with methods that are not data source specific.</span>

<span class="sd">    Design Part: 1.29</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AccessRemoteDB</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/setlyze-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../../gimaris.html">GiMaRIS</a> &raquo;</li>
    
        <li><a href="../../index.html">SETLyze 0.3 documentation</a> &raquo;</li>

          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, 2011, GiMaRIS.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>